var CanvasInstances={},RoCanvas=function(){this.clickX=[],this.clickY=[],this.startX=0,this.startY=0,this.clearRect=[0,0,0,0],this.clearCircle=[0,0,0],this.clickDrag=[],this.paint=!1,this.context={},this.undoStack=[],this.redoStack=[],this.undoButtonID,this.redoButtonID,this.shape="round",this.color="#000",this.tool="path",this.drawTool="path",this.lineWidth=5,this.bgImage=null,this.currentBgImage=null,this.factor=1,this.hardOffsetX=0,this.hardOffsetY=0,this.arrowHeadSize=30,this.hardFileLocation="",this.toolbar={colors:["#FFF","#000","#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF"],custom_color:!0,sizes:[2,5,10,25],tools:["path","rectangle","filledrectangle","circle","filledcircle","ellipse","filledellipse","arrow","textbox"],clearButton:{text:"Clear Canvas"},saveButton:null,undoButton:{text:"undo"},redoButton:{text:"redo"}};var a=this;this.RO=function(b,d){if(a.id=b,a.undoButtonID="btnUndo_"+b,a.redoButtonID="btnRedo_"+b,CanvasInstances[b]=a,d=d||{},d.toolbar)for(var e in d.toolbar)a.toolbar[e]=d.toolbar[e];if(d.settings)for(var e in d.settings)("shape"==e||"color"==e||"tool"==e||"lineWidth"==e||"arrowHeadSize"==e||"hardFileLocation"==e)&&(console.log("Setting:"+e),a[e]=d.settings[e]);a.fileLocation(),a.canvas=document.getElementById(b),document.getElementById(b).style.cursor="crosshair",d.backgroundImage?a.bgImage=d.backgroundImage:(a.bgImage=new Image,a.bgImage.src=a.canvas.toDataURL("image/jpeg")),d.cssScale&&(a.factor=d.cssScale),d.hardOffsetY&&(a.hardOffsetY=d.hardOffsetY),d.hardOffsetX&&(a.hardOffsetX=d.hardOffsetX);var f=a.canvas.parentNode,g=document.createElement("div");if(g.className="canvas_toolbar",toolBarHTML="",a.toolbar.colors){toolBarHTML+='<div class="ColorPicker">',toolBarHTML+='<div style="float:left;">Farve:</div>';for(c in a.toolbar.colors){var i="";("WHITE"==a.toolbar.colors[c]||"#FFF"==a.toolbar.colors[c]||"#FFFFFF"==a.toolbar.colors[c])&&(console.log(a.toolbar.colors[c]),i=" url("+a.filepath+"img/white_color.png) no-repeat 0 0;-webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;"),toolBarHTML+='<a id="color_'+c+'" href="#" class="ColorPicker" onclick="CanvasInstances[\''+a.id+"'].setColor('"+a.toolbar.colors[c]+'\');return false;" style="background:'+a.toolbar.colors[c]+i+';">&nbsp;</a> '}toolBarHTML+="</div>"}if(a.toolbar.custom_color&&(toolBarHTML+='<div class="CustomColorPicker">',toolBarHTML+='&nbsp; Custom:&nbsp;<a href="#" style="background:white;" onclick="CanvasInstances[\''+a.id+"'].setColor(this.style.background);return false;\" id='customColorChoice"+a.id+"'>&nbsp;</a> #<input type='text' size='6' maxlength='6' onkeyup=\"CanvasInstances['"+a.id+"'].customColor(this.value);\">",toolBarHTML+="</div>"),a.toolbar.sizes){toolBarHTML+='<div class="SizePicker">',toolBarHTML+="<div>Streg:</div>";for(s in a.toolbar.sizes)toolBarHTML+='<a href="#" id=\'size_'+a.toolbar.sizes[s]+"_"+a.id+"'  onclick=\"CanvasInstances['"+a.id+"'].setSize("+a.toolbar.sizes[s]+');return false;"><div style="width:'+a.toolbar.sizes[s]+"px;height:"+a.toolbar.sizes[s]+"px;background-color:black;border-radius:"+a.toolbar.sizes[s]+'px;margin-left:15px;">&nbsp;</div></a>';toolBarHTML+="</div>"}if(a.toolbar.tools&&a.toolbar.tools.length>1){toolBarHTML+='<div class="tools">',toolBarHTML+='<div style="float:left;">Pen:</div>';for(tool in a.toolbar.tools){var j="lnkTool_"+a.id+"_"+a.toolbar.tools[tool];toolBarHTML+='<span class="tool_'+a.toolbar.tools[tool]+'"><a id="'+j+"\" href='#' onclick=\"CanvasInstances['"+a.id+"'].setTool('"+a.toolbar.tools[tool]+'\');return false;" title="'+a.toolbar.tools[tool]+'"></a></span>'}toolBarHTML+="</div>"}if(a.toolbar.clearButton||a.toolbar.saveButton){if(toolBarHTML+='<div class="buttons_'+this.id+'" style="clear:both;">&nbsp;</div>',toolBarHTML+="<p>",a.toolbar.clearButton&&(toolBarHTML+='<input type="button" value="'+a.toolbar.clearButton.text+'"'+" onclick=\"CanvasInstances['"+a.id+"'].clearCanvas();\">"),a.toolbar.saveButton){var k="";a.toolbar.saveButton.callback&&(k=' onclick="'+a.toolbar.saveButton.callback+'(this);"'),toolBarHTML+='<input type="button" id="RoCanvasSave_'+this.id+'" value="'+a.toolbar.saveButton.text+'"'+k+">"}a.toolbar.undoButton&&(toolBarHTML+='<input type="button" id="'+a.undoButtonID+'" disabled value="'+a.toolbar.undoButton.text+'"'+" onclick=\"CanvasInstances['"+a.id+"'].undo();\">"),a.toolbar.redoButton&&(toolBarHTML+='<input type="button" id="'+a.redoButtonID+'" disabled value="'+a.toolbar.redoButton.text+'"'+" onclick=\"CanvasInstances['"+a.id+"'].redo();\">"),toolBarHTML+="</p>"}g.innerHTML=toolBarHTML,f.appendChild(g),a.canvas.getContext&&(a.context=a.canvas.getContext("2d"),a.context.strokeStyle=a.color,a.context.lineJoin=a.shape,a.context.lineWidth=a.lineWidth),a.context.clearRect(0,0,a.canvas.width,a.canvas.height),a.context.drawImage(a.bgImage,0,0),a.currentBgImage=new Image,a.currentBgImage.src=a.canvas.toDataURL("image/jpeg"),a.setTool(a.tool),a.setSize(a.context.lineWidth),a.setColor(a.context.strokeStyle),a.canvas.addEventListener("mousedown",function(b){var c=(b.pageX-this.offsetLeft-a.hardOffsetX)*a.factor;a.startX=c;var d=(b.pageY-this.offsetTop-a.hardOffsetY)*a.factor;a.startY=d,a.paint=!0,"path"==a.drawTool&&(a.addClick(c,d),a.redraw())},!1),a.canvas.addEventListener("mousemove",function(b){if(a.paint){a.context.clearRect(0,0,a.canvas.width,a.canvas.height),a.context.drawImage(a.currentBgImage,0,0);var c=(b.pageY-this.offsetTop-a.hardOffsetY)*a.factor,d=(b.pageX-this.offsetLeft-a.hardOffsetX)*a.factor;switch(a.drawTool){case"rectangle":case"filledrectangle":w=d-a.startX,h=c-a.startY,"rectangle"==a.drawTool?a.context.strokeRect(a.startX,a.startY,w,h):a.context.fillRect(a.startX,a.startY,w,h);break;case"circle":case"filledcircle":w=Math.abs(d-a.startX),h=Math.abs(c-a.startY),r=h>w?h:w,a.context.beginPath(),a.context.arc(a.startX,a.startY,r,0,2*Math.PI),a.context.closePath(),"circle"==a.drawTool?a.context.stroke():a.context.fill();break;case"filledellipse":a.drawEllipse(a.startX,a.startY,d-a.startX,c-a.startY,!0);break;case"ellipse":a.drawEllipse(a.startX,a.startY,d-a.startX,c-a.startY,!1);break;case"arrow":a.canvas_arrow(a.startX,a.startY,d,c);break;case"textbox":break;default:a.addClick(d,c,!0)}a.redraw()}},!1),a.canvas.addEventListener("mouseup",function(){switch(a.paint=!1,a.clickX=new Array,a.clickY=new Array,a.clickDrag=new Array,a.clearRect=[0,0,0,0],a.clearCircle=[0,0,0],a.drawTool){case"textbox":var c=prompt("Text","");a.context.beginPath(),a.context.font="34pt Arial",a.context.fillText(c,a.startX,a.startY+50),a.context.closePath()}a.updateCurrentState()},!1),this.canvas.addEventListener("mouseleave",function(){a.paint=!1},!1)},this.drawEllipseByCenter=function(a,b,c,d){drawEllipse(a-c/2,b-d/2,c,d)},this.drawEllipse=function(b,c,d,e,f){var g=a.context,h=.5522848,i=d/2*h,j=e/2*h,k=b+d,l=c+e,m=b+d/2,n=c+e/2;g.beginPath(),g.moveTo(b,n),g.bezierCurveTo(b,n-j,m-i,c,m,c),g.bezierCurveTo(m+i,c,k,n-j,k,n),g.bezierCurveTo(k,n+j,m+i,l,m,l),g.bezierCurveTo(m-i,l,b,n+j,b,n),g.closePath(),f?g.fill():g.stroke(),g.closePath()},this.canvas_arrow=function(b,c,d,e){var f=a.arrowHeadSize,g=d-b,h=e-c,i=Math.atan2(h,g);a.context.beginPath(),a.context.moveTo(b,c),a.context.lineTo(d,e),a.context.lineTo(d-f*Math.cos(i-Math.PI/6),e-f*Math.sin(i-Math.PI/6)),a.context.moveTo(d,e),a.context.lineTo(d-f*Math.cos(i+Math.PI/6),e-f*Math.sin(i+Math.PI/6)),a.context.stroke(),a.context.closePath()},this.addClick=function(b,c,d){a.clickX.push(b),a.clickY.push(c),a.clickDrag.push(d)},this.redraw=function(){for(var b=0;b<a.clickX.length;b++)a.context.beginPath(),a.clickDrag[b]&&b?a.context.moveTo(a.clickX[b-1],a.clickY[b-1]):a.context.moveTo(a.clickX[b]-1,a.clickY[b]),a.context.lineTo(a.clickX[b],a.clickY[b]),a.context.closePath(),a.context.stroke()},this.clearCanvas=function(){oldLineWidth=a.context.lineWidth,a.context.clearRect(0,0,a.canvas.width,a.canvas.height),a.canvas.width=a.canvas.width,a.clickX=new Array,a.clickY=new Array,RoCanvas.clickDrag=new Array,a.setSize(oldLineWidth),a.context.lineJoin=a.shape,a.setColor(a.color),a.context.drawImage(a.bgImage,0,0),a.updateCurrentState()},this.updateCurrentState=function(){a.undoStack.push(a.currentBgImage.src),a.redoStack=[],a.currentBgImage.src=a.canvas.toDataURL("image/jpeg"),document.getElementById(a.redoButtonID)&&(document.getElementById(a.redoButtonID).disabled=!0),document.getElementById(a.undoButtonID)&&(document.getElementById(a.undoButtonID).disabled=!1)},this.undo=function(){return a.undoStack.length<1?!1:(a.redoStack.push(a.currentBgImage.src),a.currentBgImage.src=a.undoStack.pop(),a.context.clearRect(0,0,a.canvas.width,a.canvas.height),a.context.drawImage(a.currentBgImage,0,0),document.getElementById(a.redoButtonID)&&(document.getElementById(a.redoButtonID).disabled=a.redoStack.length<1),document.getElementById(a.undoButtonID)&&(document.getElementById(a.undoButtonID).disabled=a.undoStack.length<1),!0)},this.redo=function(){return a.redoStack.length<1?!1:(a.undoStack.push(a.currentBgImage.src),a.currentBgImage.src=a.redoStack.pop(),a.context.clearRect(0,0,a.canvas.width,a.canvas.height),a.context.drawImage(a.currentBgImage,0,0),document.getElementById(a.redoButtonID)&&(document.getElementById(a.redoButtonID).disabled=a.redoStack.length<1),document.getElementById(a.undoButtonID)&&(document.getElementById(a.undoButtonID).disabled=a.undoStack.length<1),!0)},this.setSize=function(b){a.context.lineWidth=b;for(s in a.toolbar.sizes){var c="size_"+a.toolbar.sizes[s]+"_"+a.id;document.getElementById(c)&&(document.getElementById(c).className=a.toolbar.sizes[s]===b?"selected":"")}},this.setTool=function(b){a.drawTool=b;for(itool in a.toolbar.tools){var c="lnkTool_"+a.id+"_"+a.toolbar.tools[itool];document.getElementById(c)&&(document.getElementById(c).className=a.toolbar.tools[itool]===b?"selected":"")}},this.setColor=function(b){a.context.strokeStyle=b,a.context.fillStyle=b,a.color=b;for(c in a.toolbar.colors){var d="color_"+c;document.getElementById(d)&&(document.getElementById(d).className=a.toolbar.colors[c].toUpperCase()==b.toUpperCase()?"selected":"")}},this.fileLocation=function(){if(""!=a.hardFileLocation)return a.filepath=a.hardFileLocation,void 0;var b=document.getElementsByTagName("script");for(i=0;i<b.length;i++)if(b[i].src&&b[i].src.indexOf(!1)){path=b[i].src;break}path=path.replace(/annocan\.js.*$/,""),a.filepath=path},this.customColor=function(a){document.getElementById("customColorChoice"+this.id).style.background="#"+a,this.setColor("#"+a)},this.serialize=function(){var a=this.canvas.toDataURL("image/jpeg");return a}};